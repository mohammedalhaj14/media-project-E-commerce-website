# Stage 1: The Base Image
# Uses the official PHP 8.0 image with the Apache web server
FROM php:8.0-apache-bullseye AS base

# Set the working directory to the web root
WORKDIR /var/www/html

# 1. Install System Dependencies and PHP Extensions
# This command installs the MySQL driver (pdo_mysql) needed for your external database connection
# and enables Apache's rewrite module for clean URLs.
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/* && \
    \
    # Install PHP MySQL/MariaDB extension
    docker-php-ext-install pdo pdo_mysql && \
    \
    # Enable Apache Rewrite Module
    a2enmod rewrite

# 2. Copy the Application Code
# Copies all files from your project root into the container's web root
COPY . .

# 3. Correct Permissions (Security Best Practice)
# Ensures the web server user (www-data) owns the application files for security and functionality
RUN chown -R www-data:www-data /var/www/html

# 4. Expose the port (Mainly documentation for container networking)
EXPOSE 80

# 5. Start the Apache web server
CMD ["apache2-foreground"]